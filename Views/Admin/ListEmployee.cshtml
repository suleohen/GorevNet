@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model List<Employee>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Personel Listesi</h1>
    <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-download fa-sm text-white-50"></i> Rapor Oluştur
    </a>
</div>

<!-- Anti-forgery token -->
@Html.AntiForgeryToken()

<div class="card shadow mb-4">
    <!-- Card Header - Dropdown -->
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <div class="dropdown no-arrow">
            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                 aria-labelledby="dropdownMenuLink">
                <div class="dropdown-header">Options:</div>
                <a class="dropdown-item" href="/Admin/CreateEmployee">Personel Ekle</a>
                <a class="dropdown-item" href="/Admin/BulkCreateEmployees">Toplu Personel Ekle</a>
            </div>
        </div>
    </div>
    <!-- Card Body -->
    <div class="card-body">
        <p>
            Burada aktif personelleri görebilirsiniz.
        </p>
        <table class="table table-bordered">
            <thead class="thead-light">
                <tr>
                    <th>İsim</th>
                    <th>Soyisim</th>
                    <th>Email</th>
                    <th>Departman</th>
                    <th>Pozisyon</th>
                    <th>İşe Başlama Tarihi</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr id="employee-row-@item.Id">
                        <td>@item.FirstName</td>
                        <td>@item.LastName</td>
                        <td>@item.Email</td>
                        <td>@item.Department</td>
                        <td>@item.Position</td>
                        <td>@item.HireDate.ToString("dd.MM.yyyy")</td>
                        <td>
                            @if (item.IsActive)
                            {
                                <span class="badge badge-success">Aktif</span>
                            }
                            else
                            {
                                <span class="badge badge-secondary">Pasif</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <!-- İNCELE BUTONU EKLENDİ -->
                                <a href="@Url.Action("DetailEmployee", "Admin", new { id = item.Id })"
                                   class="btn btn-sm btn-primary" title="İncele">
                                    <i class="fas fa-eye"></i>
                                </a>

                                <a href="@Url.Action("EditEmployee", "Admin", new { id = item.Id })"
                                   class="btn btn-sm btn-warning" title="Düzenle">
                                    <i class="fas fa-edit"></i>
                                </a>

                                @if (item.IsActive)
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-danger delete-employee"
                                            data-id="@item.Id"
                                            data-name="@item.FirstName @item.LastName"
                                            title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                }
                                else
                                {
                                    <span class="btn btn-sm btn-secondary disabled" title="Zaten pasif">
                                        <i class="fas fa-ban"></i>
                                    </span>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Silme butonuna tıklandığında
            $('.delete-employee').on('click', function () {
                const employeeId = $(this).data('id');
                const employeeName = $(this).data('name');

                Swal.fire({
                    title: 'Emin misiniz?',
                    text: `${employeeName} adlı personeli silmek istediğinizden emin misiniz?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Evet, Sil!',
                    cancelButtonText: 'İptal'
                }).then((result) => {
                    if (result.isConfirmed) {
                        deleteEmployee(employeeId);
                    }
                });
            });
        });

        function deleteEmployee(employeeId) {
            // Anti-forgery token'ı al
            const token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '@Url.Action("DeactivateEmployee", "Admin")', // DeleteEmployee yerine DeactivateEmployee kullan
                type: 'POST',
                data: {
                    id: employeeId,
                    __RequestVerificationToken: token
                },
                beforeSend: function () {
                    // Loading göstergesi
                    Swal.fire({
                        title: 'Siliniyor...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Başarılı!',
                            text: response.message,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            // Sayfayı yenile
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Hata!',
                            text: response.message
                        });
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata!',
                        text: 'İşlem sırasında bir hata oluştu: ' + error
                    });
                }
            });
        }
    </script>
}